worker_processes 1;

events {
    worker_connections 1024;
}

http {
    upstream api_auth {
        server api-auth-java:8082;
    }

    upstream api_core {
        server api-core-java:8081;
    }

    server {
        listen 80;

        # ✅ /api/auth/** → api-auth-java (가장 구체적인 경로 우선)
        location /api/auth/ {
            # /api/auth/signup → /signup으로 변환
            rewrite ^/api/auth/(.*)$ /$1 break;
            
            proxy_pass http://api_auth;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            # CORS 헤더
            add_header Access-Control-Allow-Origin $http_origin always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
            add_header Access-Control-Allow-Credentials "true" always;
        }

        # ✅ /api/** → api-core-java
        location /api/ {
            # /api/posts → /posts로 변환
            rewrite ^/api/(.*)$ /$1 break;
            
            proxy_pass http://api_core;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            # CORS 헤더
            add_header Access-Control-Allow-Origin $http_origin always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
            add_header Access-Control-Allow-Credentials "true" always;
        }
    }
}
worker_processes 1;

events {
    worker_connections 1024;
}

http {
    upstream api_auth {
        server api-auth-java:8082;
    }

    upstream api_core {
        server api-core-java:8081;
    }

    server {
        listen 80;

        # ✅ /api/auth/** → api-auth-java (가장 구체적인 경로 우선)
        location /api/auth/ {
            # /api/auth/signup → /api/auth/signup 그대로 전달 (백엔드는 /signup으로 매핑)
            rewrite ^/api/auth/(.*)$ /$1 break;
            
            proxy_pass http://api_auth;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 인증 헤더 전달 (중요!)
            proxy_set_header Authorization $http_authorization;
            proxy_pass_request_headers on;
            
            # CORS 헤더
            add_header Access-Control-Allow-Origin $http_origin always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
            add_header Access-Control-Allow-Credentials "true" always;
        }

        # ✅ /api/** → api-core-java
        location /api/ {
            # /api/posts → /api/posts 그대로 전달 (백엔드가 /api/posts로 매핑되어 있음)
            proxy_pass http://api_core;
            
            # 기본 헤더
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            
            # ✅ 모든 원본 헤더를 그대로 전달 (Authorization 포함)
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            
            # ✅ 특별히 Authorization 헤더 명시 (대소문자 주의!)
            proxy_set_header Authorization $http_authorization;
            
            # CORS 헤더
            add_header Access-Control-Allow-Origin $http_origin always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
            add_header Access-Control-Allow-Credentials "true" always;
        }
    }
}
worker_processes 1;

events {
    worker_connections 1024;
}

http {
    upstream api_auth {
        server api-auth-java:8082;
    }

    upstream api_core {
        server api-core-java:8081;
    }

    server {
        listen 80;

        # ✅ /api/auth/** → api-auth-java
        location /api/auth/ {
            rewrite ^/api/auth/(.*)$ /$1 break;
            
            proxy_pass http://api_auth;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # ✅ Authorization 헤더 전달
            proxy_set_header Authorization $http_authorization;
            proxy_pass_request_headers on;
            
            # ✅ CORS 헤더는 백엔드에서 처리하므로 Nginx에서는 제거
            # Spring Security의 CORS 설정이 적용됩니다
        }

        # ✅ /api/** → api-core-java
        location /api/ {
            proxy_pass http://api_core;
            
            # 기본 헤더
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            
            # ✅ 모든 원본 헤더를 그대로 전달
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            
            # ✅ Authorization 헤더 명시적 전달
            proxy_set_header Authorization $http_authorization;
            
            # ✅ CORS는 백엔드(Spring)에서 처리
        }
    }
}